## 섹션 9. 스프링 트랜잭션 이해

### 스프링 트랜잭션 소개

### 프로젝트 생성

- [https://github.com/spring-roadmap/spring-db2-transaction](https://github.com/spring-roadmap/spring-db2-transaction)

### 트랜잭션 적용 확인

- [TxBasicTest.java](https://github.com/spring-roadmap/spring-db2-transaction/blob/main/src/test/java/hello/springtx/apply/TxBasicTest.java)

#### 스프링 컨테이너에 트랜잭션 프록시 등록

<img width="801" alt="스프링 컨테이너에 트랜잭션 프록시 등록" src="https://user-images.githubusercontent.com/64997245/202195133-afb1dead-be7a-41a3-bc9f-ecefc3a17440.png">

- @Transactional 애노테이션이 특정 클래스나 메서드에 하나라도 있으면 있으면 트랜잭션 AOP는 프록시를 만들어서 스프링 컨테이너에 등록한다.
- 그리고 실제 basicService 객체 대신에 프록시인 basicService$$CGLIB 를 스프링 빈에 등록한다.
- 프록시는 내부에 실제 basicService 를 참조하게 된다.
- 여기서 핵심은 실제 객체 대신에 프록시가 스프링 컨테이너에 등록되었다는 점이다.
- 클라이언트인 txBasicTest 는 스프링 컨테이너에 @Autowired BasicService basicService 로 의존관계 주입을 요청한다.
- 스프링 컨테이너에는 실제 객체 대신에 프록시가 스프링 빈으로 등록되어 있기 때문에 프록시를 주입한다.
- 프록시는 BasicService 를 상속해서 만들어지기 때문에 다형성을 활용할 수 있다.
- 따라서 BasicService 대신에 프록시인 BasicService$$CGLIB 를 주입할 수 있다.

#### basicService.tx() 호출

- 클라이언트가 basicService.tx() 를 호출하면, 프록시의 tx() 가 호출된다.
- 여기서 프록시는 tx() 메서드가 트랜잭션을 사용할 수 있는지 확인해본다.
- tx() 메서드에는 @Transactional 이 붙어있으므로 트랜잭션 적용 대상이다.
- 따라서 트랜잭션을 시작한 다음에 실제 basicService.tx() 를 호출한다.
- 그리고 실제 basicService.tx() 의 호출이 끝나서 프록시로 제어가(리턴) 돌아오면 프록시는 트랜잭션 로직을 커밋하거나 롤백해서 트랜잭션을 종료한다.

#### basicService.nonTx() 호출

- 클라이언트가 basicService.nonTx() 를 호출하면, 트랜잭션 프록시의 nonTx() 가 호출된다.
- 여기서 nonTx() 메서드가 트랜잭션을 사용할 수 있는지 확인해본다.
- nonTx()에는 @Transactional 이 없으므로 적용 대상이 아니다.
- 따라서 트랜잭션을 시작하지 않고, basicService.nonTx() 를 호출하고 종료한다.

### 트랜잭션 적용 위치

- 스프링에서 우선순위는 항상 더 구체적이고 자세한 것이 높은 우선순위를 가진다.
- [TxLevelTest.java](https://github.com/spring-roadmap/spring-db2-transaction/blob/main/src/test/java/hello/springtx/apply/TxLevelTest.java)
- 인터페이스에 @Transactional 사용하는 것은 스프링 공식 메뉴얼에서 권장하지 않는 방법이다.
- AOP를 적용하는 방식에 따라서 인터페이스에 애노테이션을 두면 AOP가 적용이 되지 않는 경우도 있기 때문이다.
- 가급적 구체 클래스에 @Transactional 을 사용하자.

### 트랜잭션 AOP 주의 사항 - 프록시 내부 호출1

### 트랜잭션 AOP 주의 사항 - 프록시 내부 호출2

### 트랜잭션 AOP 주의 사항 - 초기화 시점

### 트랜잭션 옵션 소개

### 예외와 트랜잭션 커밋, 롤백 - 기본

### 예외와 트랜잭션 커밋, 롤백 - 활용

### 정리
